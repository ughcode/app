<script>

/*
  Weather App
  filename: weather.js
 */

(function () { // <-- We've wrapped almost everything in a function

  var apiUrl = 'http://api.openweathermap.org/data/2.5/weather';

  var apiKey = '<REPLACE WITH YOUR KEY>';

  function getWeather(locationObject, callback) {
    var url = apiUrl + '?' +
      parameterize(locationObject) +
      '&APPID=' + apiKey +
      '&units=imperial';

    makeRequest(url, function () {
      var response = this.responseText;
      response = JSON.parse(response);
      callback(response);
    });
  }

  function parameterize(object) {
    var params = [];
    for (var key in object) {
      params.push(key + '=' + encodeURIComponent(object[key]));
    }
    return params.join('&');
  }

  function makeRequest(url, callback) {
    var xhrObject = new XMLHttpRequest();
    xhrObject.onload = callback;
    xhrObject.open('GET', url, true);
    xhrObject.send();
  }

  function getUserCoordinates(callback) {
    navigator.geolocation.getCurrentPosition(function (position) {
      if (position.coords) {
        callback(position.coords);
      } else {
        console.error("Didn't get a valid coordinate, Miao!");
      }
    });
  }

  function printWeather(weatherData) {
    var currentTemperature = weatherData.main.temp;
    var location = weatherData.name;
    console.log("The current temprature in " + location +
                " is: " + currentTemperature);
  }

  function weatherForMyLocation() {
    getUserCoordinates(function (coord) {
      getWeather({
        lon: coord.longitude,
        lat: coord.latitude
      }, printWeather);
    });
  }

  function weatherForZipCodes(zips) {
    for (var i = 0; i < zips.length; i++) {
      getWeather({
        zip: zips[i]
      }, printWeather);
    }
  }

  window.weatherApp = { // <-- Pay attention here
    weatherForMyLocation : weatherForMyLocation,
    weatherForZipCodes   : weatherForZipCodes
  };

})(); // <-- Note how we're immediately invoking here

</script>
